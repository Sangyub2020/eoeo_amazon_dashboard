# Amazon US 계정별 비용 안분 설계

## 개요
SKU 단위가 아닌 계정 단위로 청구되는 비용들(예: 프리미엄 서비스 이용료, FBA 창고 이용료 등)을 각 SKU별 매출에 따라 안분하는 시스템입니다.

## 데이터베이스 구조

### 1. `amazon_us_account_monthly_costs` 테이블
계정별 월별 비용을 저장하는 테이블입니다.

**주요 컬럼:**
- `account_name`: 계정 이름 (account_master 참조)
- `year`, `month`: 연도, 월
- `premium_service_fee`: 아마존 프리미엄 서비스 이용료
- `inbound_placement_fee`: Inbound Placement Fee
- `monthly_storage_fee`: Monthly Storage Fee
- `longterm_storage_fee`: Longterm Storage Fee
- `fba_removal_order_disposal_fee`: FBA Removal Order: Disposal Fee
- `fba_removal_order_return_fee`: FBA Removal Order: Return Fee
- `subscription_fee`: 구독료
- `paid_services_fee`: 유료 서비스 수수료
- `other_account_fees`: 기타 계정 단위 비용
- `total_account_cost`: 총 계정 비용 (모든 항목의 합계)
- `is_allocated`: 안분 완료 여부
- `allocated_at`: 안분 완료 시각
- `allocation_method`: 안분 방법 (sales_ratio: 매출 비율, quantity_ratio: 수량 비율 등)

### 2. `amazon_us_monthly_data` 테이블
안분된 비용을 저장하기 위해 다음 컬럼이 추가되었습니다:
- `allocated_account_cost`: 해당 SKU에 안분된 계정 비용 금액

## 안분 로직

### 1. 비용 수집
1. Amazon에서 계정 단위 비용 데이터를 가져옵니다 (SP-API 또는 수동 입력)
2. `amazon_us_account_monthly_costs` 테이블에 저장합니다
3. 각 비용 항목을 입력하고 `total_account_cost`를 계산합니다

### 2. 안분 계산
각 계정의 월별 비용을 해당 계정의 SKU별 매출 비율로 안분합니다:

```sql
-- 예시: 매출 비율 기반 안분
WITH account_total_sales AS (
  SELECT 
    sm.amazon_account_name,
    amd.year,
    amd.month,
    SUM(amd.gross_sales) as total_sales
  FROM amazon_us_monthly_data amd
  JOIN sku_master sm ON amd.sku = sm.sku
  WHERE sm.amazon_account_name = '계정명'
    AND amd.year = 2024
    AND amd.month = 1
  GROUP BY sm.amazon_account_name, amd.year, amd.month
),
sku_sales AS (
  SELECT 
    amd.sku,
    sm.amazon_account_name,
    amd.year,
    amd.month,
    amd.gross_sales,
    ats.total_sales
  FROM amazon_us_monthly_data amd
  JOIN sku_master sm ON amd.sku = sm.sku
  JOIN account_total_sales ats ON 
    sm.amazon_account_name = ats.amazon_account_name
    AND amd.year = ats.year
    AND amd.month = ats.month
  WHERE sm.amazon_account_name = '계정명'
    AND amd.year = 2024
    AND amd.month = 1
)
UPDATE amazon_us_monthly_data amd
SET allocated_account_cost = (
  SELECT 
    (ss.gross_sales / NULLIF(ss.total_sales, 0)) * ac.total_account_cost
  FROM sku_sales ss
  JOIN amazon_us_account_monthly_costs ac ON
    ss.amazon_account_name = ac.account_name
    AND ss.year = ac.year
    AND ss.month = ac.month
  WHERE ss.sku = amd.sku
    AND ss.year = amd.year
    AND ss.month = amd.month
)
WHERE EXISTS (
  SELECT 1 FROM sku_sales ss
  WHERE ss.sku = amd.sku
    AND ss.year = amd.year
    AND ss.month = amd.month
);
```

### 3. 안분 완료 처리
안분이 완료되면 `amazon_us_account_monthly_costs` 테이블의 `is_allocated`를 `TRUE`로, `allocated_at`을 현재 시각으로 업데이트합니다.

## API 엔드포인트 설계

### 1. 계정 비용 입력/수정
- `POST /api/amazon-us-account-costs` - 계정 비용 생성
- `PUT /api/amazon-us-account-costs/[id]` - 계정 비용 수정
- `GET /api/amazon-us-account-costs` - 계정 비용 조회

### 2. 안분 실행
- `POST /api/amazon-us-account-costs/allocate` - 특정 계정/월의 비용을 SKU별로 안분
- `POST /api/amazon-us-account-costs/allocate-all` - 모든 미안분 비용을 일괄 안분

## 사용 시나리오

### 시나리오 1: 월별 비용 입력
1. Amazon에서 계정 단위 비용 데이터를 확인
2. 관리 페이지에서 해당 월의 비용을 입력
3. 각 비용 항목을 입력 (프리미엄 서비스, 창고 이용료 등)
4. 저장하면 `total_account_cost`가 자동 계산됨

### 시나리오 2: 자동 안분
1. "안분 실행" 버튼 클릭
2. 해당 계정의 해당 월 모든 SKU의 매출을 조회
3. 각 SKU의 매출 비율을 계산
4. 계정 비용을 비율에 따라 안분
5. 각 SKU의 `allocated_account_cost`에 저장
6. `is_allocated = TRUE`로 업데이트

### 시나리오 3: 안분 재계산
1. 기존 안분 결과를 초기화 (`allocated_account_cost = 0`)
2. 새로운 매출 데이터로 재안분 실행
3. 업데이트된 안분 금액 저장

## 주의사항

1. **매출이 0인 경우**: 매출이 없는 SKU는 안분되지 않습니다 (또는 수량 비율로 안분 가능)
2. **안분 방법 선택**: 매출 비율 또는 수량 비율 중 선택 가능
3. **중복 안분 방지**: `is_allocated = TRUE`인 경우 재안분 시 확인 필요
4. **데이터 정합성**: 계정명이 `sku_master`의 `amazon_account_name`과 일치해야 함

## 향후 확장

1. **안분 방법 추가**: 
   - 고정 비율 안분
   - 브랜드별 안분
   - 제품 카테고리별 안분

2. **비용 항목 확장**:
   - 광고 비용
   - 프로모션 비용
   - 기타 운영 비용

3. **자동화**:
   - Amazon SP-API를 통한 자동 비용 수집
   - 월말 자동 안분 실행

